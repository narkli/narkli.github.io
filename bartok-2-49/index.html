<!doctype html>
<html lang="en">	           
	<head id="newhead">
		<title>JRP Piano Roll</title>

<!-- styles -->
<link href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Lusitana:400,700" rel="stylesheet" type="text/css">
<!-- link rel="stylesheet" type="text/css" href="/css/normalize.css"/ -->
<!-- link rel="stylesheet" type="text/css" href="/css/style.css"/ -->

<style>

body#white {
    background: white;
}

div#home-page {
   width: 100%;
}


</style>


</head>

	<body id="white">

		<div id="help" style="display:none;";>

<div style="position: fixed; bottom:0%; right:0%; background:#ffdddd; margin-bottom:5px; width:290px; padding:30px">

<style>

table#help-table td {
   text-align: left;
   vertical-align:top; 
}

table#help-table tr {
   vertical-align:top; 
}

</style>

<table id="help-table">

<tr><td colspan="2">
   <b style="font-size:110%;">Keyboard commands</b>
</td>
</tr>

<tr><td style="padding-right:20px;"><b>?</b></td>
    <td> Hide this help menu.</td>
</tr>

<tr><td style="padding-right:20px;"><b>C</b></td>
    <td> Toggle display of control panel </td>
</tr>

<tr><td style="padding-right:20px;"><b>H</b></td>
    <td> Toggle full-height view </td>
</tr>

<tr><td style="padding-right:20px;"><b>W</b></td>
    <td> Toggle full-width view </td>
</tr>

<tr><td style="padding-right:20px;"><b>[</b></td>
    <td> Zoom out </td>
</tr>

<tr><td style="padding-right:20px;"><b>]</b></td>
    <td> Zoom in </td>
</tr>

<tr><td style="padding-right:20px;"><b>G</b></td>
    <td> Toggle grand-staff display</td>
</tr>

<tr><td style="padding-right:20px;"><b>R</b></td>
    <td> Toggle round/square notes</td>
</tr>

<tr><td style="padding-right:20px;"><b>1-9</b></td>
    <td> Toggle display of first-ninth voice </td>
</tr>

<tr><td style="padding-right:20px;"><b><nobr>shift-1</nobr></b></td>
    <td> Toggle showing only first voice</td>
</tr>

<tr><td style="padding-right:20px;"><b>0</b></td>
    <td> Toggle display of all voices</td>
</tr>

<tr><td style="padding-right:20px;"><b>X</b></td>
    <td> Toggle display of lowest pitch in each voice</td>
</tr>

<tr><td style="padding-right:20px;"><b>N</b></td>
    <td> Toggle display of hightest pitch in each voice</td>
</tr>

</table>

</div>

		</div>

		<div class="page container" id="home-page">

			<section id="content">

<style>

svg {
   display: none;
}


svg rect.highlight {
   fill:  #786D5F;
   opacity: 1;
}


svg rect.note:hover {
   /* fill:    red; */
   stroke:  silver;
   stroke-width: 10;
}

table#controls {
   position:      fixed; 
   background:    white; 
   margin-left:   30px; 
   margin-bottom: 30px;
}

table#controls tr td {
   padding: 7px;
   min-width: 150px;
}

table#table-svg, table#table-svg tr td {
   padding: 0;
   margin: 0;
}


</style>

<div id="interface">
<table id="controls">
<tr><td colspan=3>
<h1> <i>Mikrokosmos</i>, Vol. II, No. 49, B&eacute;la Bart&oacute;k
 
<style>

.play {
	display: inline-block;
	text-indent: -19999px;
	background: url(mp3.png) no-repeat 0 0;
	width: 56px;
	height: 27px;
	margin-left: 15px;
	position: relative;
	top: 3px;
}

.pause {
	display: inline-block;
	text-indent: -19999px;
	background: url(mp3-pause.png) no-repeat 0 0;
	width: 56px;
	height: 27px;
	margin-left: 15px;
	position: relative;
	top: 3px;
}


</style>

<span id="audio2" 
   style="position:relative; cursor:hand; cursor:pointer; top:15px" 
   onclick="PlayAudioFile2('Jos2824', this);" href class="play">play</span>


</h1>
</td></tr>
<tr>

<td style="text-align:right;">
width <input id="width" style="width:50px; text-align:right;" onchange="displayWidth(this.value);" value="100" min="100" step="50" max="800" type="number">% <br>
round notes <input id="round-notes" onchange="displayRound(this.checked);" type=checkbox checked><br>
note connectors <input id="note-connectors" onchange="displayLines(this.checked);" type=checkbox checked><br>
</td>

<td style="text-align:right;">
grand staff <input id="grand-staff" onchange="displayStafflines(this.checked);" type=checkbox><br>
maxima <input id="maxima" onchange="displayMaxima(this.checked);" type=checkbox><br>
minima <input id="minima" onchange="displayMinima(this.checked);" type=checkbox><br>
</td>

<td style="text-align:right;">
Superius <input onchange="displayVoice(this.checked, 4);" id="v1" type=checkbox checked><br>
Altus <input onchange="displayVoice(this.checked, 3);" id="v2" type=checkbox checked><br>
Tenor <input onchange="displayVoice(this.checked, 2);" id="v3" type=checkbox checked><br>
Bassus <input onchange="displayVoice(this.checked, 1);" id="v4" type=checkbox checked><br>
</td>


<td>
<div id="info"></div>
</td>

</tr>


</table>

<div style="height:200px"></div>
</div>

<table id="svg-table">
<tr><td>

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewPort="0 40 13.622 41" viewBox="-10 -10 183.464 61" width="183.464" height="61">
<filter id="constantOpacity">
	<feComponentTransfer>
		<feFuncA type="table" tableValues="0 .5 .5" />
	</feComponentTransfer>
</filter>
<rect class="background" x="-500%" y="-500%" width="1000%" height="1000%" style="fill:white" />
<g transform="scale(12, -1) translate(0, -81)" >
	<g class="staff-lines" stroke-width="0.1" stroke="#555555">
		<path d="M0 64.5 L13.622 64.5" />
		<path d="M0 67.5 L13.622 67.5" />
		<path d="M0 71.5 L13.622 71.5" />
		<path d="M0 74.5 L13.622 74.5" />
		<path d="M0 77.5 L13.622 77.5" />
		<path d="M0 43.5 L13.622 43.5" />
		<path d="M0 47.5 L13.622 47.5" />
		<path d="M0 50.5 L13.622 50.5" />
		<path d="M0 53.5 L13.622 53.5" />
		<path d="M0 57.5 L13.622 57.5" />
	</g>
	<g style="stroke-width:0.1; stroke:black;">
		<g class="note-lines track-2" fill="none" stroke="hsl(180.000000, 100%, 75%)" stroke-dasharray="0.25" stroke-width="0.02">
			<path d=" M0.940943 48.5 L0.94488 48.5 L0.94488 50.5" />
			<path d=" M1.04527 50.5 L1.1811 50.5 L1.1811 52.5" />
			<path d=" M1.2746 52.5 L1.41732 52.5 L1.41732 53.5" />
			<path d=" M1.54626 53.5 L2.12598 53.5 L2.12598 50.5" />
			<path d=" M2.36515 50.5 L2.59842 50.5 L2.59842 54.5" />
			<path d=" M2.47145 52.5 L2.59842 52.5 L2.59842 54.5" />
			<path d=" M2.72244 54.5 L2.83464 54.5 L2.83464 55.5" />
			<path d=" M3.32283 55.5 L3.5433 55.5 L3.5433 52.5" />
			<path d=" M3.4183 50.5 L3.5433 50.5 L3.5433 52.5" />
			<path d=" M3.77854 52.5 L3.77854 48.5" />
			<path d=" M3.89074 48.5 L4.01574 48.5 L4.01574 54.5" />
			<path d=" M4.14468 54.5 L4.25196 54.5 L4.25196 50.5" />
			<path d=" M4.48621 50.5 L4.48818 50.5 L4.48818 55.5" />
			<path d=" M4.6181 55.5 L4.7244 55.5 L4.7244 52.5" />
			<path d=" M4.83759 52.5 L4.96062 52.5 L4.96062 54.5" />
			<path d=" M5.09842 54.5 L5.19684 54.5 L5.19684 48.5" />
			<path d=" M5.33365 48.5 L5.43306 48.5 L5.43306 50.5" />
			<path d=" M5.56987 50.5 L5.9055 50.5 L5.9055 52.5" />
			<path d=" M6.01081 52.5 L6.14172 52.5 L6.14172 54.5" />
			<path d=" M6.27853 54.5 L6.37794 54.5 L6.37794 55.5" />
			<path d=" M6.48719 55.5 L7.79526 55.5 L7.79526 55.5" />
			<path d=" M8.05609 55.5 L8.2677 55.5 L8.2677 52.5" />
			<path d=" M8.15353 54.5 L8.2677 54.5 L8.2677 52.5" />
			<path d=" M8.38581 52.5 L8.50392 52.5 L8.50392 50.5" />
			<path d=" M8.66829 50.5 L9.21258 50.5 L9.21258 53.5" />
			<path d=" M9.46455 53.5 L9.68502 53.5 L9.68502 50.5" />
			<path d=" M9.56199 52.5 L9.68502 52.5 L9.68502 50.5" />
			<path d=" M9.79132 50.5 L9.92124 50.5 L9.92124 48.5" />
			<path d=" M10.3838 48.5 L10.3937 48.5 L10.3937 52.5" />
			<path d=" M10.5177 52.5 L10.6299 52.5 L10.6299 53.5" />
			<path d=" M10.8848 53.5 L11.1023 53.5 L11.1023 55.5" />
			<path d=" M10.9901 50.5 L11.1023 50.5 L11.1023 55.5" />
			<path d=" M11.2362 55.5 L11.5748 55.5 L11.5748 52.5" />
			<path d=" M11.7047 52.5 L11.811 52.5 L11.811 48.5" />
			<path d=" M11.9193 48.5 L12.2834 48.5 L12.2834 53.5" />
			<path d=" M12.4124 53.5 L12.5197 53.5 L12.5197 50.5" />
			<path d=" M12.6417 50.5 L12.7559 50.5 L12.7559 50.5" />
			<path d=" M12.8622 50.5 L12.9921 50.5 L12.9921 55.5" />
			<path d=" M13.1181 55.5 L13.2283 55.5 L13.2283 52.5" />
			<path d=" M13.3445 52.5 L13.4645 52.5 L13.4645 48.5" />
		</g>
		<g class="note-lines track-1" fill="none" stroke="hsl(60, 100%, 75%)" stroke-dasharray="0.25" stroke-width="0.02">
			<path d=" M0.232283 67.5 L0.23622 67.5 L0.23622 69.5" />
			<path d=" M0.336614 69.5 L0.47244 69.5 L0.47244 71.5" />
			<path d=" M0.565944 71.5 L0.70866 71.5 L0.70866 72.5" />
			<path d=" M0.837597 72.5 L1.41732 72.5 L1.41732 69.5" />
			<path d=" M1.65649 69.5 L1.88976 69.5 L1.88976 73.5" />
			<path d=" M1.76279 71.5 L1.88976 71.5 L1.88976 73.5" />
			<path d=" M2.01378 73.5 L2.12598 73.5 L2.12598 74.5" />
			<path d=" M2.25984 74.5 L2.83464 74.5 L2.83464 72.5" />
			<path d=" M3.06988 72.5 L3.06988 71.5" />
			<path d=" M3.18208 71.5 L3.30708 71.5 L3.30708 69.5" />
			<path d=" M3.43602 69.5 L3.5433 69.5 L3.5433 67.5" />
			<path d=" M3.77755 67.5 L3.77952 67.5 L3.77952 72.5" />
			<path d=" M3.90944 72.5 L4.01574 72.5 L4.01574 69.5" />
			<path d=" M4.12893 69.5 L4.25196 69.5 L4.25196 71.5" />
			<path d=" M4.50787 71.5 L4.7244 71.5 L4.7244 72.5" />
			<path d=" M4.62499 67.5 L4.7244 67.5 L4.7244 72.5" />
			<path d=" M4.86121 72.5 L4.96062 72.5 L4.96062 69.5" />
			<path d=" M5.06593 69.5 L5.19684 69.5 L5.19684 74.5" />
			<path d=" M5.33365 74.5 L5.43306 74.5 L5.43306 71.5" />
			<path d=" M5.54231 71.5 L5.66928 71.5 L5.66928 67.5" />
			<path d=" M5.93011 67.5 L7.0866 67.5 L7.0866 74.5" />
			<path d=" M7.34743 74.5 L7.55904 74.5 L7.55904 71.5" />
			<path d=" M7.44487 73.5 L7.55904 73.5 L7.55904 71.5" />
			<path d=" M7.67715 71.5 L7.79526 71.5 L7.79526 69.5" />
			<path d=" M7.95963 69.5 L8.50392 69.5 L8.50392 72.5" />
			<path d=" M8.75589 72.5 L8.97636 72.5 L8.97636 69.5" />
			<path d=" M8.85333 71.5 L8.97636 71.5 L8.97636 69.5" />
			<path d=" M9.08266 69.5 L9.21258 69.5 L9.21258 67.5" />
			<path d=" M9.32085 67.5 L9.92124 67.5 L9.92124 70.5" />
			<path d=" M10.1762 70.5 L10.3937 70.5 L10.3937 67.5" />
			<path d=" M10.2815 69.5 L10.3937 69.5 L10.3937 67.5" />
			<path d=" M10.5275 67.5 L10.6299 67.5 L10.6299 69.5" />
			<path d=" M10.8563 69.5 L10.8661 69.5 L10.8661 72.5" />
			<path d=" M10.996 72.5 L11.1023 72.5 L11.1023 71.5" />
			<path d=" M11.2106 71.5 L11.3386 71.5 L11.3386 72.5" />
			<path d=" M11.4675 72.5 L11.5748 72.5 L11.5748 67.5" />
			<path d=" M11.7195 67.5 L11.811 67.5 L11.811 70.5" />
			<path d=" M11.933 70.5 L12.0472 70.5 L12.0472 69.5" />
			<path d=" M12.1535 69.5 L12.2834 69.5 L12.2834 74.5" />
			<path d=" M12.4094 74.5 L12.5197 74.5 L12.5197 71.5" />
			<path d=" M12.6358 71.5 L12.7559 71.5 L12.7559 72.5" />
		</g>
		<g opacity="0.5" class="note-backdrops track-2" style="fill:white;" >
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-0d709 offt-0d941 minima"	rx="1"	ry="1"	x="0.70866"	y="48"	width="0.232283"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-0d945 offt-1d045"	rx="1"	ry="1"	x="0.94488"	y="50"	width="0.100393"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-1d181 offt-1d275"	rx="1"	ry="1"	x="1.1811"	y="52"	width="0.0935037"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-1d417 offt-1d546"	rx="1"	ry="1"	x="1.41732"	y="53"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-2d126 offt-2d365"	rx="1"	ry="1"	x="2.12598"	y="50"	width="0.239173"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-2d362 offt-2d471"	rx="1"	ry="1"	x="2.3622"	y="52"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-2d598 offt-2d722"	rx="1"	ry="1"	x="2.59842"	y="54"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-2d835 offt-3d323 maxima"	rx="1"	ry="1"	x="2.83464"	y="55"	width="0.488188"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-3d307 offt-3d418"	rx="1"	ry="1"	x="3.30708"	y="50"	width="0.11122"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-3d543 offt-3d779"	rx="1"	ry="1"	x="3.5433"	y="52"	width="0.235236"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-3d779 offt-3d891 minima"	rx="1"	ry="1"	x="3.77854"	y="48"	width="0.112205"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-4d016 offt-4d145"	rx="1"	ry="1"	x="4.01574"	y="54"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-4d252 offt-4d486"	rx="1"	ry="1"	x="4.25196"	y="50"	width="0.234252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-4d488 offt-4d618 maxima"	rx="1"	ry="1"	x="4.48818"	y="55"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-4d724 offt-4d838"	rx="1"	ry="1"	x="4.7244"	y="52"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-4d961 offt-5d098"	rx="1"	ry="1"	x="4.96062"	y="54"	width="0.137795"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-5d197 offt-5d334 minima"	rx="1"	ry="1"	x="5.19684"	y="48"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-5d433 offt-5d570"	rx="1"	ry="1"	x="5.43306"	y="50"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-5d906 offt-6d011"	rx="1"	ry="1"	x="5.9055"	y="52"	width="0.105315"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-6d142 offt-6d279"	rx="1"	ry="1"	x="6.14172"	y="54"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-6d378 offt-6d487 maxima"	rx="1"	ry="1"	x="6.37794"	y="55"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-7d795 offt-8d056 maxima"	rx="1"	ry="1"	x="7.79526"	y="55"	width="0.260826"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-8d031 offt-8d154"	rx="1"	ry="1"	x="8.03148"	y="54"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-8d268 offt-8d386"	rx="1"	ry="1"	x="8.2677"	y="52"	width="0.11811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-8d504 offt-8d668"	rx="1"	ry="1"	x="8.50392"	y="50"	width="0.16437"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-9d213 offt-9d465"	rx="1"	ry="1"	x="9.21258"	y="53"	width="0.251968"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-9d449 offt-9d562"	rx="1"	ry="1"	x="9.4488"	y="52"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-9d685 offt-9d791"	rx="1"	ry="1"	x="9.68502"	y="50"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-9d921 offt-10d384 minima"	rx="1"	ry="1"	x="9.92124"	y="48"	width="0.462597"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-10d394 offt-10d518"	rx="1"	ry="1"	x="10.3937"	y="52"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-10d630 offt-10d885"	rx="1"	ry="1"	x="10.6299"	y="53"	width="0.254921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-10d866 offt-10d990"	rx="1"	ry="1"	x="10.8661"	y="50"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-11d102 offt-11d236 maxima"	rx="1"	ry="1"	x="11.1023"	y="55"	width="0.133858"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-11d575 offt-11d705"	rx="1"	ry="1"	x="11.5748"	y="52"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-11d811 offt-11d919 minima"	rx="1"	ry="1"	x="11.811"	y="48"	width="0.108268"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-12d283 offt-12d412"	rx="1"	ry="1"	x="12.2834"	y="53"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-12d520 offt-12d642"	rx="1"	ry="1"	x="12.5197"	y="50"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-12d756 offt-12d862"	rx="1"	ry="1"	x="12.7559"	y="50"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-12d992 offt-13d118 maxima"	rx="1"	ry="1"	x="12.9921"	y="55"	width="0.125984"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-13d228 offt-13d344"	rx="1"	ry="1"	x="13.2283"	y="52"	width="0.116141"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-13d465 offt-13d622 minima"	rx="1"	ry="1"	x="13.4645"	y="48"	width="0.15748"	height="1" />
		</g>
		<g opacity="0.5" class="note-backdrops track-1" style="fill:white;" >
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-0d000 offt-0d232 minima"	rx="1"	ry="1"	x="0"	y="67"	width="0.232283"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-0d236 offt-0d337"	rx="1"	ry="1"	x="0.23622"	y="69"	width="0.100393"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-0d472 offt-0d566"	rx="1"	ry="1"	x="0.47244"	y="71"	width="0.0935038"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-0d709 offt-0d838"	rx="1"	ry="1"	x="0.70866"	y="72"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-1d417 offt-1d656"	rx="1"	ry="1"	x="1.41732"	y="69"	width="0.239173"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-1d654 offt-1d763"	rx="1"	ry="1"	x="1.65354"	y="71"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-73 ont-1d890 offt-2d014"	rx="1"	ry="1"	x="1.88976"	y="73"	width="0.124015"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-2d126 offt-2d260 maxima"	rx="1"	ry="1"	x="2.12598"	y="74"	width="0.133858"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-2d835 offt-3d070"	rx="1"	ry="1"	x="2.83464"	y="72"	width="0.235236"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-3d070 offt-3d182"	rx="1"	ry="1"	x="3.06988"	y="71"	width="0.112204"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-3d307 offt-3d436"	rx="1"	ry="1"	x="3.30708"	y="69"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-3d543 offt-3d778 minima"	rx="1"	ry="1"	x="3.5433"	y="67"	width="0.234252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-3d780 offt-3d909"	rx="1"	ry="1"	x="3.77952"	y="72"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-4d016 offt-4d129"	rx="1"	ry="1"	x="4.01574"	y="69"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-4d252 offt-4d508"	rx="1"	ry="1"	x="4.25196"	y="71"	width="0.255905"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-4d488 offt-4d625 minima"	rx="1"	ry="1"	x="4.48818"	y="67"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-4d724 offt-4d861"	rx="1"	ry="1"	x="4.7244"	y="72"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-4d961 offt-5d066"	rx="1"	ry="1"	x="4.96062"	y="69"	width="0.105315"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-5d197 offt-5d334 maxima"	rx="1"	ry="1"	x="5.19684"	y="74"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-5d433 offt-5d542"	rx="1"	ry="1"	x="5.43306"	y="71"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-5d669 offt-5d930 minima"	rx="1"	ry="1"	x="5.66928"	y="67"	width="0.260826"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-7d087 offt-7d347 maxima"	rx="1"	ry="1"	x="7.0866"	y="74"	width="0.260826"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-73 ont-7d323 offt-7d445"	rx="1"	ry="1"	x="7.32282"	y="73"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-7d559 offt-7d677"	rx="1"	ry="1"	x="7.55904"	y="71"	width="0.11811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-7d795 offt-7d960"	rx="1"	ry="1"	x="7.79526"	y="69"	width="0.16437"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-8d504 offt-8d756"	rx="1"	ry="1"	x="8.50392"	y="72"	width="0.251968"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-8d740 offt-8d853"	rx="1"	ry="1"	x="8.74014"	y="71"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-8d976 offt-9d083"	rx="1"	ry="1"	x="8.97636"	y="69"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-9d213 offt-9d321 minima"	rx="1"	ry="1"	x="9.21258"	y="67"	width="0.108268"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-70 ont-9d921 offt-10d176"	rx="1"	ry="1"	x="9.92124"	y="70"	width="0.254921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-10d157 offt-10d281"	rx="1"	ry="1"	x="10.1575"	y="69"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-10d394 offt-10d528 minima"	rx="1"	ry="1"	x="10.3937"	y="67"	width="0.133858"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-10d630 offt-10d856"	rx="1"	ry="1"	x="10.6299"	y="69"	width="0.226377"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-10d866 offt-10d996"	rx="1"	ry="1"	x="10.8661"	y="72"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-11d102 offt-11d211"	rx="1"	ry="1"	x="11.1023"	y="71"	width="0.108268"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-11d339 offt-11d467"	rx="1"	ry="1"	x="11.3386"	y="72"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-11d575 offt-11d719 minima"	rx="1"	ry="1"	x="11.5748"	y="67"	width="0.144685"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-70 ont-11d811 offt-11d933"	rx="1"	ry="1"	x="11.811"	y="70"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-12d047 offt-12d154"	rx="1"	ry="1"	x="12.0472"	y="69"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-12d283 offt-12d409 maxima"	rx="1"	ry="1"	x="12.2834"	y="74"	width="0.125984"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-12d520 offt-12d636"	rx="1"	ry="1"	x="12.5197"	y="71"	width="0.116141"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-12d756 offt-12d913"	rx="1"	ry="1"	x="12.7559"	y="72"	width="0.15748"	height="1" />
		</g>
		<g class="track-2" filter="url(#constantOpacity)" style="opacity:1; fill:hsl(180, 100%, 75%);" >
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-0d709 offt-0d941 minima"	rx="1"	ry="1"	x="0.70866"	y="48"	width="0.232283"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-0d945 offt-1d045"	rx="1"	ry="1"	x="0.94488"	y="50"	width="0.100393"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-1d181 offt-1d275"	rx="1"	ry="1"	x="1.1811"	y="52"	width="0.0935037"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-1d417 offt-1d546"	rx="1"	ry="1"	x="1.41732"	y="53"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-2d126 offt-2d365"	rx="1"	ry="1"	x="2.12598"	y="50"	width="0.239173"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-2d362 offt-2d471"	rx="1"	ry="1"	x="2.3622"	y="52"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-2d598 offt-2d722"	rx="1"	ry="1"	x="2.59842"	y="54"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-2d835 offt-3d323 maxima"	rx="1"	ry="1"	x="2.83464"	y="55"	width="0.488188"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-3d307 offt-3d418"	rx="1"	ry="1"	x="3.30708"	y="50"	width="0.11122"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-3d543 offt-3d779"	rx="1"	ry="1"	x="3.5433"	y="52"	width="0.235236"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-3d779 offt-3d891 minima"	rx="1"	ry="1"	x="3.77854"	y="48"	width="0.112205"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-4d016 offt-4d145"	rx="1"	ry="1"	x="4.01574"	y="54"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-4d252 offt-4d486"	rx="1"	ry="1"	x="4.25196"	y="50"	width="0.234252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-4d488 offt-4d618 maxima"	rx="1"	ry="1"	x="4.48818"	y="55"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-4d724 offt-4d838"	rx="1"	ry="1"	x="4.7244"	y="52"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-4d961 offt-5d098"	rx="1"	ry="1"	x="4.96062"	y="54"	width="0.137795"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-5d197 offt-5d334 minima"	rx="1"	ry="1"	x="5.19684"	y="48"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-5d433 offt-5d570"	rx="1"	ry="1"	x="5.43306"	y="50"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-5d906 offt-6d011"	rx="1"	ry="1"	x="5.9055"	y="52"	width="0.105315"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-6d142 offt-6d279"	rx="1"	ry="1"	x="6.14172"	y="54"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-6d378 offt-6d487 maxima"	rx="1"	ry="1"	x="6.37794"	y="55"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-7d795 offt-8d056 maxima"	rx="1"	ry="1"	x="7.79526"	y="55"	width="0.260826"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-54 ont-8d031 offt-8d154"	rx="1"	ry="1"	x="8.03148"	y="54"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-8d268 offt-8d386"	rx="1"	ry="1"	x="8.2677"	y="52"	width="0.11811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-8d504 offt-8d668"	rx="1"	ry="1"	x="8.50392"	y="50"	width="0.16437"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-9d213 offt-9d465"	rx="1"	ry="1"	x="9.21258"	y="53"	width="0.251968"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-9d449 offt-9d562"	rx="1"	ry="1"	x="9.4488"	y="52"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-9d685 offt-9d791"	rx="1"	ry="1"	x="9.68502"	y="50"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-9d921 offt-10d384 minima"	rx="1"	ry="1"	x="9.92124"	y="48"	width="0.462597"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-10d394 offt-10d518"	rx="1"	ry="1"	x="10.3937"	y="52"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-10d630 offt-10d885"	rx="1"	ry="1"	x="10.6299"	y="53"	width="0.254921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-10d866 offt-10d990"	rx="1"	ry="1"	x="10.8661"	y="50"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-11d102 offt-11d236 maxima"	rx="1"	ry="1"	x="11.1023"	y="55"	width="0.133858"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-11d575 offt-11d705"	rx="1"	ry="1"	x="11.5748"	y="52"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-11d811 offt-11d919 minima"	rx="1"	ry="1"	x="11.811"	y="48"	width="0.108268"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-53 ont-12d283 offt-12d412"	rx="1"	ry="1"	x="12.2834"	y="53"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-12d520 offt-12d642"	rx="1"	ry="1"	x="12.5197"	y="50"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-50 ont-12d756 offt-12d862"	rx="1"	ry="1"	x="12.7559"	y="50"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-55 ont-12d992 offt-13d118 maxima"	rx="1"	ry="1"	x="12.9921"	y="55"	width="0.125984"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-52 ont-13d228 offt-13d344"	rx="1"	ry="1"	x="13.2283"	y="52"	width="0.116141"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-48 ont-13d465 offt-13d622 minima"	rx="1"	ry="1"	x="13.4645"	y="48"	width="0.15748"	height="1" />
		</g>
		<g class="track-1" filter="url(#constantOpacity)" style="opacity:1; fill:hsl(60, 100%, 75%);" >
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-0d000 offt-0d232 minima"	rx="1"	ry="1"	x="0"	y="67"	width="0.232283"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-0d236 offt-0d337"	rx="1"	ry="1"	x="0.23622"	y="69"	width="0.100393"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-0d472 offt-0d566"	rx="1"	ry="1"	x="0.47244"	y="71"	width="0.0935038"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-0d709 offt-0d838"	rx="1"	ry="1"	x="0.70866"	y="72"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-1d417 offt-1d656"	rx="1"	ry="1"	x="1.41732"	y="69"	width="0.239173"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-1d654 offt-1d763"	rx="1"	ry="1"	x="1.65354"	y="71"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-73 ont-1d890 offt-2d014"	rx="1"	ry="1"	x="1.88976"	y="73"	width="0.124015"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-2d126 offt-2d260 maxima"	rx="1"	ry="1"	x="2.12598"	y="74"	width="0.133858"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-2d835 offt-3d070"	rx="1"	ry="1"	x="2.83464"	y="72"	width="0.235236"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-3d070 offt-3d182"	rx="1"	ry="1"	x="3.06988"	y="71"	width="0.112204"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-3d307 offt-3d436"	rx="1"	ry="1"	x="3.30708"	y="69"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-3d543 offt-3d778 minima"	rx="1"	ry="1"	x="3.5433"	y="67"	width="0.234252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-3d780 offt-3d909"	rx="1"	ry="1"	x="3.77952"	y="72"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-4d016 offt-4d129"	rx="1"	ry="1"	x="4.01574"	y="69"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-4d252 offt-4d508"	rx="1"	ry="1"	x="4.25196"	y="71"	width="0.255905"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-4d488 offt-4d625 minima"	rx="1"	ry="1"	x="4.48818"	y="67"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-4d724 offt-4d861"	rx="1"	ry="1"	x="4.7244"	y="72"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-4d961 offt-5d066"	rx="1"	ry="1"	x="4.96062"	y="69"	width="0.105315"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-5d197 offt-5d334 maxima"	rx="1"	ry="1"	x="5.19684"	y="74"	width="0.136811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-5d433 offt-5d542"	rx="1"	ry="1"	x="5.43306"	y="71"	width="0.109252"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-5d669 offt-5d930 minima"	rx="1"	ry="1"	x="5.66928"	y="67"	width="0.260826"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-7d087 offt-7d347 maxima"	rx="1"	ry="1"	x="7.0866"	y="74"	width="0.260826"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-73 ont-7d323 offt-7d445"	rx="1"	ry="1"	x="7.32282"	y="73"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-7d559 offt-7d677"	rx="1"	ry="1"	x="7.55904"	y="71"	width="0.11811"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-7d795 offt-7d960"	rx="1"	ry="1"	x="7.79526"	y="69"	width="0.16437"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-8d504 offt-8d756"	rx="1"	ry="1"	x="8.50392"	y="72"	width="0.251968"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-8d740 offt-8d853"	rx="1"	ry="1"	x="8.74014"	y="71"	width="0.113189"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-8d976 offt-9d083"	rx="1"	ry="1"	x="8.97636"	y="69"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-9d213 offt-9d321 minima"	rx="1"	ry="1"	x="9.21258"	y="67"	width="0.108268"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-70 ont-9d921 offt-10d176"	rx="1"	ry="1"	x="9.92124"	y="70"	width="0.254921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-10d157 offt-10d281"	rx="1"	ry="1"	x="10.1575"	y="69"	width="0.124016"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-10d394 offt-10d528 minima"	rx="1"	ry="1"	x="10.3937"	y="67"	width="0.133858"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-10d630 offt-10d856"	rx="1"	ry="1"	x="10.6299"	y="69"	width="0.226377"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-10d866 offt-10d996"	rx="1"	ry="1"	x="10.8661"	y="72"	width="0.129921"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-11d102 offt-11d211"	rx="1"	ry="1"	x="11.1023"	y="71"	width="0.108268"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-11d339 offt-11d467"	rx="1"	ry="1"	x="11.3386"	y="72"	width="0.128937"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-67 ont-11d575 offt-11d719 minima"	rx="1"	ry="1"	x="11.5748"	y="67"	width="0.144685"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-70 ont-11d811 offt-11d933"	rx="1"	ry="1"	x="11.811"	y="70"	width="0.122047"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-69 ont-12d047 offt-12d154"	rx="1"	ry="1"	x="12.0472"	y="69"	width="0.106299"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-74 ont-12d283 offt-12d409 maxima"	rx="1"	ry="1"	x="12.2834"	y="74"	width="0.125984"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-71 ont-12d520 offt-12d636"	rx="1"	ry="1"	x="12.5197"	y="71"	width="0.116141"	height="1" />
			<rect vector-effect="non-scaling-stroke" class="note key-72 ont-12d756 offt-12d913"	rx="1"	ry="1"	x="12.7559"	y="72"	width="0.15748"	height="1" />
		</g>
	</g>
</g>
</svg>
<?mid2svg
	no49.mid --dark --staff -l -r --gs --dash -a 12 -b 10
?>



</td></tr></table>




			</section>

		</div>

<script>
// vim: ts=3 ft=javascript

var LASTHEIGHT     = -1;
var LASTWIDTH      = -1;
var POLL_FREQUENCY = 20;
var LAST_TIME      = -1;
var CURRENT_TIME   = -1;
var REFRESH;
var ANCHOR_STOP;
var STARTTIME      = -1;
//var OFFSET         = 0.83;
var OFFSET         = 0.0

var NOTE_OFF_TIMES = [];
var NOTE_ON_TIMES  = [];
var RECTS          = [];

var PLAY_STATE = 0;

// used to monitor track states with "0" command.

window.addEventListener("DOMContentLoaded", function(event) {

	prepareTimemap();

	// Set up display according to options on page:
	var voice1 = document.querySelector("#v1");
	var voice2 = document.querySelector("#v2");
	var voice3 = document.querySelector("#v3");
	var voice4 = document.querySelector("#v4");

	voice1.checked = true;
	voice2.checked = true;
	voice3.checked = true;
	voice4.checked = true;

	displayVoice(voice1.checked, 4);
	displayVoice(voice2.checked, 3);
	displayVoice(voice3.checked, 2);
	displayVoice(voice4.checked, 1);

	var grandstaff = document.querySelector("#grand-staff");
	displayStafflines(grandstaff.checked);

	var rounded = document.querySelector("#round-notes");
	displayRound(rounded.checked);

	var lines = document.querySelector("#note-connectors");
	displayLines(lines.checked);

	var maxima = document.querySelector("#maxima");
	displayMaxima(maxima.checked);

	var width = document.querySelector("#width");
	displayWidth(width.value);

	var svg = document.querySelector("svg");
	svg.style.display = 'block';

});


window.addEventListener("click", function(event) {
	if (event.target.nodeName !== "rect") {
		return;
	}
	var clas = event.target.className.baseVal;
	if (!clas) {
		return;
	}
	var matches;
	var info = document.querySelector("#info");
	if (matches = clas.match(/key-(\d+)/)) {
		var key = matches[1];
		console.log("KEY = ", key);
		info.innerHTML = "Pitch: " + MidiToDiatonicPC(key);
	}

   // start playing at that point in music
   var audio = document.querySelector("audio");
   if (!audio) {
      PlayAudioFile2('Jos2824');
      var audio = document.querySelector("audio");
      if (audio) {
         audio.pause();
      }
   }
   var child = audio.firstChild;
   if (child.nodeName !== "SOURCE") {
      console.log("CHILD IS NOT SOURCE");
      PlayAudioFile2('Jos2824');
      audio.pause();
   } else {
      console.log("CHILD IS SOURCE");
   }
   var matches;
   var ontime = 0;
   if (!audio.paused) {
      audio.pause();
   }
   if (matches = clas.match(/ont-([^\s]+)/)) {
      ontime = matches[1].replace(/d/, '.');
      STARTTIME = parseFloat(ontime) - OFFSET - 0.01;
      if (STARTTIME < 0) {
         STATTIME = 0.001;
      }
      audio.play();

   }
});


function MidiToDiatonicPC(value) {
	value = parseInt(value);
	var octave = parseInt(value / 12);
	var pc12 = parseInt(value % 12);
	var output = "";
	switch (pc12) {
		case 0:	output += "C";	break;
		case 1:	output += "C#";  break;
		case 2:	output += "D";	break;
		case 3:	output += "Eb";  break;
		case 4:	output += "E";	break;
		case 5:	output += "F";	break;
		case 6:	output += "F#";  break;
		case 7:	output += "G";	break;
		case 8:	output += "G#";  break;
		case 9:	output += "A";	break;
		case 10:  output += "Bb";  break;
		case 11:  output += "B";	break;
	}
	output += octave;
	return output;
}



////////////////////////
//
// prepareTimemap --
//

function prepareTimemap() {
	var svg = document.querySelector("svg");
	// var offt = svg.querySelectorAll("[class^='offt-']");
	RECTS = svg.querySelectorAll("rect");
	NOTE_OFF_TIMES = [];
	NOTE_OFF_TIMES = [];
	var matches;
	var offtime;
	var ontime;
	for (var i=0; i<RECTS.length; i++) {

		if (matches = RECTS[i].className.baseVal.match(/ont-([^\s]+)/)) {
			ont = parseFloat(matches[1].replace(/d/, "."));
			NOTE_ON_TIMES.push({time: ont - OFFSET, index: i});
		}

		if (matches = RECTS[i].className.baseVal.match(/offt-([^\s]+)/)) {
			offtime = parseFloat(matches[1].replace(/d/, "."));
			NOTE_OFF_TIMES.push({time: offtime - OFFSET, index: i});
		}

	}
}



//////////////////////////////
//
// PlayAudioFile2 -- play/pause an audio file.
//

function PlayAudioFile2(jrpid, element, time) {
   if (!element) {
      element = document.querySelector("#audio2");
   }

	// The JRPID is not the same as the currently playing file
	// (or there is no file playing).  So start the new one.
	if (!AUDIO) {
		AUDIO = document.getElementById('audio');
	}
	if (!AUDIO) {
		document.body.innerHTML += '<audio id="audio"></audio>\n';
		AUDIO = document.getElementById('audio');
	}
	if (!AUDIO) {
		console.log('Error: could not set up audio interface\n');
		return false;
	}
	AUDIO.setAttribute('controls', 'controls');
	AUDIO.style.position = 'fixed';
	AUDIO.style.bottom = '0';
	AUDIO.style.right = '0';
	AUDIO.style.zIndex = '1';

   if (time) {
      AUDIO.currentTime(time);
   }

   AUDIO.addEventListener('pause', pauseCallback);
   AUDIO.addEventListener('play', playCallback);

	var audiobutton;
	if (jrpid != AUDIOjrpid) {
		if (!!AUDIOid) {
			// turn of previously playing audio file:
			audiobutton = document.getElementById(AUDIOid);
			if (!!audiobutton && !!audiobutton.className) {
				if (audiobutton.className.match(/mp3/)) {
					audiobutton.className = 'mp3play';
				} else {
					audiobutton.className = 'play';
				}
			}
		}
		AUDIO.removeAttribute('controls');
		AUDIO.pause();
		
		AUDIOid = element.id;
		var source = '';
		// Can't have seekable dynamic content in audio element:
		//source += '<source src="/data?a=mp3&id=' + jrpid + '" ';
		if (window.location.href.match(/tasso/i)) {
			source += '<source src="no49.mp3" ';
		} else {
			source += '<source src="no49.mp3" ';
		}
		source += 'type="audio/mpeg"/>\n';
		AUDIO.innerHTML = source;

		AUDIOjrpid = jrpid;
		AUDIO.load();
		AUDIO.play();
		AUDIO.setAttribute('controls', 'controls');
		var newelement = document.getElementById(AUDIOid);
		
		if (newelement.className.match(/mp3/)) {
			newelement.className = 'mp3pause';
		} else {
			newelement.className = 'pause';
		}
		return;
	}

	// The audio file is the same, so start it or pause it depending
	// on its current state:
	if (AUDIO.paused) {
		audiobutton = document.getElementById(AUDIOid);
 		if (!audiobutton) {
			return;
		}
		if (audiobutton.className.match(/mp3/)) {
			audiobutton.className = 'mp3play';
		} else {
			audiobutton.className = 'play';
		}
		if (element.className.match(/mp3/)) {
			element.className = 'mp3pause';
		} else {
			element.className = 'pause';
		}
		AUDIO.play();
		AUDIO.setAttribute('controls', 'controls');
	} else {
		audiobutton = document.getElementById(AUDIOid);
 		if (!audiobutton) {
			return;
		}
		if (audiobutton.className.match(/mp3/)) {
			audiobutton.className = 'mp3pause';
		} else {
			audiobutton.className = 'pause';
		}
		if (element.className.match(/mp3/)) {
			element.className = 'mp3play';
		} else {
			element.className = 'play';
		}
		AUDIO.pause();
		AUDIO.removeAttribute('controls');
	}
}


//////////////////////////////
//
// pauseCallback -- What to do when the audio is stopped.
//

function pauseCallback() {
	console.log("PAUSING AUDIO");
   PLAY_STATE = 0;
   unhighlightAll(NOTE_ON_TIMES);
}


//////////////////////////////
//
// unhighlightAll -- Remove "highlight" class from all given elemments.
//

function unhighlightAll(list) {
   var cn;
   var matches;
   for (var i=0; i<list.length; i++) {
      turnOffNote(list[i].index);
   }
}



//////////////////////////////
//
// turnOnNote --
//

function turnOnNote(index) {
   var rects = document.querySelectorAll("svg rect");
   // var note = RECTS[index];
   var note = rects[index];
   var cn = note.className.baseVal;
   if (!cn.match(/highlight/)) {
      cn += " highlight";
      note.className.baseVal = cn;
   }
}



//////////////////////////////
//
// tunOffNote --
//

function turnOffNote(index) {
   var rects = document.querySelectorAll("svg rect");
   var note = rects[index];
   var cn = note.getAttribute('class');
   if (cn.match(/highlight/)) {
      cn = cn.replace(/highlight/, '');
      note.setAttribute('class', cn);
   }
}



//////////////////////////////
//
// playCallback -- What to do when the audio starts playing.
//

function playCallback(event) {
	var iface = document.querySelector("audio");
   if (STARTTIME > 0) {
      console.log("PLAYING AT", STARTTIME);
      iface.currentTime = STARTTIME;
      STARTTIME = -1;
   }
	LAST_TIME = iface.currentTime;
	PLAY_STATE = 1;
	var that = this;
	REFRESH = setInterval(function() {
		if (PLAY_STATE == 0) {
			clearInterval(REFRESH);
			return;
		}
		var a = iface;
		var delta = a.currentTime - LAST_TIME;
		if (delta == 0.0) {
			return;
		}
		checkTimeMaps(a.currentTime);
		LAST_TIME = a.currentTime;
	}, POLL_FREQUENCY);
}



//////////////////////////////
//
// checkTimeMaps --  See if any notes should be turned on or off.
//

function checkTimeMaps(nowtime) {
	var tmon  = NOTE_ON_TIMES;
	var tmoff = NOTE_OFF_TIMES;

	if (!tmon)  { return; }
	if (!tmoff) { return; }

   var i;
	var ttime;
	var lasttime = LAST_TIME;

	for (i=0; i<tmon.length; i++) {
		ttime = tmon[i].time;
      if ((ttime >= lasttime) && (ttime <= nowtime + 0.015)) {
         turnOnNote(tmon[i].index);
      }
   }

	for (i=0; i<tmoff.length; i++) {
		ttime = tmoff[i].time;
      if ((ttime >= lasttime) && (ttime <= nowtime + 0.015)) {
         turnOffNote(tmon[i].index);
      }
   }

}




</script>


<script>
//
// Programmer:    Craig Stuart Sapp <craig@ccrma.stanford.edu>
// Creation Date: Thu Aug 21 12:59:01 PDT 2014
// Last Modified: Mon Sep  1 22:01:13 PDT 2014
// Filename:      .../scripts/scripts-common.js
// Web Address:   http://josquin.stanford.edu/scripts/scripts-common.js
// Syntax:        JavaScript 1.8/ECMAScript 5
// vim:				ts=3: ft=javascript
//
// Description:   JRP-specific JavaScript functions common to all pages.
//

// GLOBAL VARIABLES:
var WORKLIST;										 // Master index of works in JRP database.
var WORKLISTrecent = [];						 // List of works reverse sorted by add date.
var WORKLISTjrpid  = {};						 // Hash of works by JRP ID.
var BASEADDR       = window.location.host; // Base address of URL.
var PDFTARGET      = 'target="new"';		 // Display PDF files in separate tab/window.
var AUDIO          = null;						 // HTML5 audio interface ID.
var AUDIOjrpid     = '';  						 // currently playing audio file.
var AUDIOid        = '';                   // currently playing audio button.


// List of Key Codes.  More can be extracted from this page:
// http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
const AKey            = 65; // Letters
const BKey            = 66;
const CKey            = 67;
const DKey            = 68;
const EKey            = 69;
const FKey            = 70;
const GKey            = 71;
const HKey            = 72;
const IKey            = 73;
const JKey            = 74;
const KKey            = 75;
const LKey            = 76;
const MKey            = 77;
const NKey            = 78;
const OKey            = 79;
const PKey            = 80;
const QKey            = 81;
const RKey            = 82;
const SKey            = 83;
const TKey            = 84;
const UKey            = 85;
const VKey            = 86;
const WKey            = 87;
const XKey            = 88;
const YKey            = 89;
const ZKey            = 90;
const ZeroKey         = 48; // Numbers
const OneKey          = 49;
const TwoKey          = 50;
const ThreeKey        = 51;
const FourKey         = 52;
const FiveKey         = 53;
const SixKey          = 54;
const SevenKey        = 55;
const EightKey        = 56;
const NineKey         = 57;
const BackspaceKey    =  8; // Other
const TabKey          =  9;
const EnterKey        = 13;
const EscKey          = 27;
const SpaceKey        = 32;
const EqualsKey       = 187;
const MinusKey        = 189;
const PageUpKey       = 33;
const PageDownKey     = 34;
const EndKey          = 35;
const HomeKey         = 36;
const DeleteKey       = 46;
const ControlKey      = 17; // State keys
const AltKey          = 18;
const ShiftKey        = 16;
const CommandLeftKey  = 91; // or Window key in MSWindows, and Meta key in Unix
const CommandRightKey = 93;
const F1Key           = 112; // Function keys
const F2Key           = 113;
const F3Key           = 114;
const F4Key           = 115;
const F5Key           = 116;
const F6Key           = 117;
const F7Key           = 118;
const F8Key           = 119;
const F9Key           = 120;
const F10Key          = 121;
const SlashKey        = 191;
const SquareLeftKey   = 219;
const SquareRightKey  = 221;

// Arrows:
const UpArrowKey      = 38;    // maybe also 30 & 57373
const DownArrowKey    = 40;    // maybe also 31 & 57374
const LeftArrowKey    = 37;    // maybe also 28 & 57375
const RightArrowKey   = 39;    // maybe also 29 & 57376



//////////////////////////////
//
// InitializeWorklist -- manages setup of the WORKLIST object which 
//    contains a list of the works in the database categorized by composer.
//    If the WORKLIST object is already generated, then do nothing (so call
//    this function whenever the WORKLIST is needed).  Otherwise, the WORKLIST
//    data will be downloaded from the server, typically from 
//    /include/worklist.json.
//

function InitializeWorklist() {
   if (WORKLIST != null) {
      return;
   }

   // Eventually request a timestamp from the server, and compare
   // to WORKLIST store in localStorage, and only re-download if the
   // server has a newer WORKLIST.  For now, update once a day.
   var refreshtime = 3600 * 1;  // update once an hour
   var currenttime = parseInt(new Date() / 1000);  // convert from ms to sec.

   if ((typeof localStorage.WORKLISTrefreshtime !== 'undefined') && 
       (localStorage.WORKLISTrefreshtime < currenttime)) {
      localStorage.WORKLIST = null;
   }

   if ((typeof localStorage.WORKLIST === 'undefined') ||
         (localStorage.WORKLIST == 'null') || (localStorage.WORKLIST == '')) {
      // need to download the WORKLIST data from the server.
      localStorage.WORKLIST = ReadFile('/includes/worklist.json');
      if (localStorage.WORKLIST.match(/^\s*$/)) {
         localStorage.WORKLIST = ReadFile('/data?a=worklist-json'); 
      }
      WORKLIST = JSON.parse(localStorage.WORKLIST);
      localStorage.WORKLISTrefreshtime = currenttime + refreshtime;
   } else {
      // already have the worklist in local storage, so read from there.
      WORKLIST = JSON.parse(localStorage.WORKLIST);
   }
}



//////////////////////////////
//
// InitializeWorklistFlat -- Create a flattened list of works.  Two 
//    (global) objects will be created from the WORKLIST object: 
//    (1) WORKLISTrecent -- an array which is a list of works 
//        reverse-sorted by date added.   Also stored in 
//        sessionStorage.WORKLISTrecent.
//    (2) WORKLISTjrpid -- an object which contains works indexed by
//    JRP ID.  Also stored in sessionStorage.WORKLISTjrpid.
//

function InitializeWorklistFlat() {

   if ((WORKLISTrecent != null) && (WORKLISTrecent.length != 0)) {
      // WORILISTjrpid is presumed to be in a similar state.
      return;
   }

   InitializeWorklist();

   WORKLISTrecent = [];
   WORKLISTjrpid  = {};

   var i;
   var works;
   var jrpid;

   for (i=0; i<WORKLIST.length; i++) {
      works = WORKLIST[i].works;
      for (j=0; j<works.length; j++) {
         if (typeof works[j].comshort === 'undefined') {
            works[j].comshort = WORKLIST[i].comshort;
         }
         WORKLISTrecent.push(works[j]);
         jrpid = works[j].id;
         WORKLISTjrpid[jrpid] = works[j];
      }
   }

   WORKLISTrecent.sort(byReverseAddDate);
}



//////////////////////////////
//
// byReverseAddDate -- sort a work by reverse add date.
//


function byReverseAddDate(a, b) {
   var date1 = a.ud;
   var date2 = b.ud;

	if (!date1) { date1 = a.ad; }
	if (!date2) { date2 = b.ad; }
	if (!date1) { date1 = 0; }
	if (!date2) { date2 = 0; }
   if (date1 > date2) { return -1; } 
   if (date1 < date2) { return +1; }
   if (a.id  < b.id)  { return -1; }
   if (a.id  > b.id)  { return +1; }

   return 0;
}



//////////////////////////////
//
// GetDataFile -- download a data file from the server and keep it for
//    use later.
//

function GetDataFile(jrpid, prefix, action) {
   var variable = prefix + jrpid;

   if (typeof localStorage[variable] != 'undefined') {
      return localStorage[variable];
   }
   
   InitializeWorklistFlat();

   // Get the first section's incipit if a multi-section work:
   var pieces = jrpid.match(/^([A-Z][a-z][a-z]\d{4}[.\d]*)([a-z]*.*)/);
   var workid = pieces[1];
   var work = WORKLISTjrpid[workid];
   if (work == null) {
      work = WORKLISTjrpid[workid + pieces[2]];
   }
   if (work == null) {
      console.log('Error: ' + workid + ' not in WORKLISTjrpid.');
      return;
   }
   var i;
   if (typeof work.sections === 'undefined') {
      jrpid = workid;
   }

   // content is not in localStorage, so download, store, and return.
   var imagedata = ReadFile('http://' + BASEADDR + '/data?a=' + action + '&f=' + jrpid);
   localStorage[variable] = imagedata;
   return imagedata;
}



//////////////////////////////
//
// GetDataFileAsync -- get a data file asynchronously.
//

function GetDataFileAsync(jrpid, prefix, action, callback) {
   var variable = prefix + jrpid;

   if (typeof localStorage[variable] != 'undefined') {
      return localStorage[variable];
   }
   
   InitializeWorklistFlat();

   // Get the first section's incipit if a multi-section work:
   var pieces = jrpid.match(/^([A-Z][a-z][a-z]\d{4}[.\d]*)([a-z]*.*)/);
   var workid = pieces[1];
   var work = WORKLISTjrpid[workid];
   if (work == null) {
      work = WORKLISTjrpid[workid + pieces[2]];
   }
   if (work == null) {
      console.log('Error2: ' + workid + ' not in WORKLISTjrpid.');
      return;
   }
   var i;
   if (typeof work.sections === 'undefined') {
      jrpid = workid;
   }

   // content is not in localStorage, so download, store, and return.
   ReadFileAsync('http://' + BASEADDR + '/data?a=' + action + '&f=' + jrpid, callback);
   //localStorage[variable] = imagedata;
   // return imagedata;
}



//////////////////////////////
//
// ReadFile -- Download URL content which is returned as a string.
//      The URL must be on the same domain as index.html due to
//      JavaScript Same-Origin policy:
//         http://en.wikipedia.org/wiki/Same-origin_policy
// XMLHttpRequest object:
//         http://www.w3.org/TR/2007/WD-XMLHttpRequest-20070618
//         http://xhr.spec.whatwg.org
//         
//         See:
//  http://codingforums.com/ajax-design/123705-make-script-wait-until-request-comes-back.html
//

function ReadFile(url) {
   var request = new XMLHttpRequest();

   request.open('GET', url, false);
   request.send(null);

   var string = request.responseText;
   if ((string.length < 1000) && string.match(/Not Found/)) {
      return '';
   } else {
      return request.responseText;
   }
}



function ReadFileAsync(url, callback) {
   var request = new XMLHttpRequest();
   request.open('GET', url, true);
   request.onload = function (e) {
      if (this.readyState == 4) {
         callback(this.responseText);
      }
   };
   request.onerror = function(e) {
      console.error(request.statusText);
   };
   request.send(null);
}



//////////////////////////////
//
// GetCgiParameters -- Returns an associative array containing the
//     page's URL's CGI parameters
//

function GetCgiParameters() {
   var url = window.location.search.substring(1);
   var output = {};
   var settings = url.split('&');
   for (var i=0; i<settings.length; i++) {
      var pair = settings[i].split('=');
      pair[0] = decodeURIComponent(pair[0]);
      pair[1] = decodeURIComponent(pair[1]);
      if (typeof output[pair[0]] === 'undefined') {
         output[pair[0]] = pair[1];
      } else if (typeof output[pair[0]] === 'string') {
         var arr = [ output[pair[0]], pair[1] ];
         output[pair[0]] = arr;
      } else {
         output[pair[0]].push(pair[1]);
      }
   }
   return output;
}




//////////////////////////////
//
// GetComposerOptions -- Return an option list of composers in the worklist.
//    This is used to fill in the Composer/Repertory section list in forms
//    on various webpages.
//

function GetComposerOptions() {
   InitializeWorklist();
   var output = '';
   var longname;
   var abbr;
   var i;

   for (i=0; i<WORKLIST.length; i++) {
      longname  = WORKLIST[i].comlong;
      shortname = WORKLIST[i].comshort;
      abbr      = WORKLIST[i].repid;
      output += '<option value="' + abbr + '">';
      // output += longname + '</option>\n';
      output += shortname + '</option>\n';
      if (abbr == 'Jos') {
         output += '<option value="Joa">Josquin (secure)</option>\n';
         output += '<option value="Job">';
         output += 'Josquin&nbsp;';
         output += '(not&nbsp;secure)</option>\n';
      }
   }
   return output;
}



//////////////////////////////
//
// GetGenreOptions -- Return an option list of genres.  
//     This is used to fill in the Composer/Repertory section list 
//     in forms on various webpages.  If there is an input repe
//     Mass, Motet, or Song.
//

function GetGenreOptions(repertory) {
   if ((typeof repertory === 'undefined') || 
			(repertory == null) || (repertory == '')) {
	   // Avoiding displaying the genre list without a repertory.
	   // This is because analyses mostly need to be limited to a single repertory
	   // So that not too many images are shown on the same page.
		var opts = '<option value="mass">Masses</option>\n';
		opts += '<option value="motet">Motets</option>\n';
		opts += '<option value="song">Songs</option>\n';
      return opts;
   }

   InitializeWorklist();
   var output = '';
   var longname;
   var abbr;
   var i, j;
   var rep;
   var gen;

   var genlist1 = {};

   for (i=0; i<WORKLIST.length; i++) {
		rep = WORKLIST[i].repid;
		if (!repertory.match(/^\s*$/) && (!rep.match(repertory))) {
			continue;
		}
      gen = WORKLIST[i].genres;
      for (j=0; j<gen.length; j++) {
			genlist1[gen[j].name] = gen[j].name;
		}
	}
   var genlist2 = [];
   for (entry in genlist1) genlist2.push(entry);
	genlist2.sort();

	var output = '';
   for (i=0; i<genlist2.length; i++) {
      output += '<option value="' + genlist2[i] + '">';
	   if (genlist2[i].match('mass')) {
			output += 'Masses';
	   } else if (genlist2[i].match('motet')) {
			output += 'Motets';
	   } else if (genlist2[i].match('song')) {
			output += 'Songs';
		} else {
			output += genlist2[i];
		}
		output += '</option>\n';
   }
   return output;
}



//////////////////////////////
//
// GetGenreBrowseOptions -- Return an option list of genres.  
//     This is used to fill in the Composer/Repertory section list 
//     in forms on various webpages.  If there is an input repe
//     Mass, Motet, or Song.
//

function GetGenreBrowseOptions() {
   InitializeWorklist();
   var output = '';
   var longname;
   var abbr;
   var i, j;
   var rep;
   var gen;

   var genlist1 = {};

   for (i=0; i<WORKLIST.length; i++) {
		rep = WORKLIST[i].repid;
      gen = WORKLIST[i].genres;
      for (j=0; j<gen.length; j++) {
			genlist1[gen[j].name] = gen[j].name;
		}
	}
   var genlist2 = [];
   for (entry in genlist1) genlist2.push(entry);
	genlist2.sort();

	var output = '';
   for (i=0; i<genlist2.length; i++) {
      output += '<option value="' + genlist2[i] + '">';
	   if (genlist2[i].match('mass')) {
			output += 'Masses';
	   } else if (genlist2[i].match('motet')) {
			output += 'Motets';
	   } else if (genlist2[i].match('song')) {
			output += 'Songs';
		} else {
			output += genlist2[i];
		}
		output += '</option>\n';
   }
   return output;
}



//////////////////////////////
//
// GetWorkOptions -- Return an option list of works (for a specific
//     repertory and genre.    The repertory is required, the genre
//     is optional (show all works regardless of genre in that case).
//     This is used to fill in the Work section list in forms on 
//     various webpages.  
//

function GetWorkOptions(repertory, genre) {
   if ((typeof repertory === 'undefined') || (repertory == null)) {
      return '';
	}

   if ((typeof genre === 'undefined') || (genre == null)) {
      genre = '';
   }
   InitializeWorklist();
   var output = '';
   var longname;
   var abbr;
   var i, j;
   var works;

   var output = '';
   for (i=0; i<WORKLIST.length; i++) {
		if (!repertory.match(WORKLIST[i].repid)) {
			continue;
		}
		works = WORKLIST[i].works;
      for (j=0; j<works.length; j++) {
			if (!genre.match(/^\s*$/) && !genre.match(works[j].genre)) {
				continue;
			}
      	output += '<option value="' + works[j].id + '">';
			output += works[j].title;
			if (typeof works[j].variant !== 'undefined') {
				output += ' (' + works[j].variant + ' )';
			}
			output += '</option>\n';
		}
	}
	return output;
}



//////////////////////////////
//
// GetVoiceOptions -- Return an option list of voices.  This is used to
//     fill in the Composer/Repertory section list in forms on various
//     webpages.
//

function GetVoiceOptions() {
   output = '';
   output += '<option value="3">3 voices</option>\n';
   output += '<option value="4">4 voices</option>\n';
   output += '<option value="5+">more voices</option>\n';
   return output;
}



//////////////////////////////
//
// ClearBrowseFields -- Erase the browse filter options (useful to force
//     display of the Browse home page).
//

function ClearBrowseFields() {
   localStorage.BROWSEcomposers = '';
   localStorage.BROWSEgenres    = '';
   localStorage.BROWSEvoices    = '';
   localStorage.BROWSEtitlebox  = '';
}



//////////////////////////////
//
// ClearWorklist --
//

function ClearWorklist() {
	localStorage.removeItem('WORKLIST');
	localStorage.removeItem('WORKLISTrefreshtime');
  	localStorage.removeItem('WORKjrpid');
  	localStorage.removeItem('RECENTLYADDEDHTML');
}



/*
//////////////////////////////
//
// UpdateEzMark --
//

function UpdateEzMark() {
   $('select').not('.tricky').select2({
      width: 'off'
   });

   $('select.tricky').select2({
      width: 'off',
      containerCssClass: 'tricky-choice',
      dropdownCssClass: 'tricky-dropdown',
      dropdownAutoWidth: true
   });

//   $('input[type=checkbox]').ezMark();
//   $('input[type=radio]').ezMark();
}
*/



//////////////////////////////
//
// PlayAudioFile -- play/pause an audio file.
//

function PlayAudioFile(jrpid, element) {
	// The JRPID is not the same as the currently playing file
	// (or there is no file playing).  So start the new one.
	if (!AUDIO) {
	   AUDIO = document.getElementById('audio');
   }
	if (!AUDIO) {
		document.body.innerHTML += '<audio id="audio"></audio>\n';
	   AUDIO = document.getElementById('audio');
	}
   if (!AUDIO) {
		console.log('Error: could not set up audio interface\n');
		return false;
   }
	AUDIO.setAttribute('controls', 'controls');
	AUDIO.style.position = 'fixed';
	AUDIO.style.bottom = '0';
	AUDIO.style.right = '0';
	AUDIO.style.zIndex = '1';

	var audiobutton;
   if (jrpid != AUDIOjrpid) {
		if (!!AUDIOid) {
			// turn of previously playing audio file:
			audiobutton = document.getElementById(AUDIOid);
			if (!!audiobutton && !!audiobutton.className) {
				if (audiobutton.className.match(/mp3/)) {
					audiobutton.className = 'mp3play';
				} else {
					audiobutton.className = 'play';
				}
			}
		}
		AUDIO.removeAttribute('controls');
      AUDIO.pause();
		
      AUDIOid = element.id;
		var source = '';
		// Can't have seekable dynamic content in audio element:
		//source += '<source src="/data?a=mp3&id=' + jrpid + '" ';
		if (window.location.href.match(/tasso/i)) {
			source += '<source src="http://data.tassomusic.org/audio/mp3/' + jrpid + '.mp3" ';
		} else {
			source += '<source src="/audio/mp3/' + jrpid + '.mp3" ';
		}
		source += 'type="audio/mpeg"/>\n';
		AUDIO.innerHTML = source;

		AUDIOjrpid = jrpid;
		AUDIO.load();
		AUDIO.play();
		AUDIO.setAttribute('controls', 'controls');
		var newelement = document.getElementById(AUDIOid);
		
		if (newelement.className.match(/mp3/)) {
			newelement.className = 'mp3pause';
		} else {
			newelement.className = 'pause';
		}
		return;
	}

	// The audio file is the same, so start it or pause it depending
	// on its current state:
	if (AUDIO.paused) {
		audiobutton = document.getElementById(AUDIOid);
 		if (!audiobutton) {
			return;
		}
		if (audiobutton.className.match(/mp3/)) {
			audiobutton.className = 'mp3play';
		} else {
			audiobutton.className = 'play';
		}
		if (element.className.match(/mp3/)) {
			element.className = 'mp3pause';
		} else {
			element.className = 'pause';
		}
		AUDIO.play();
		AUDIO.setAttribute('controls', 'controls');
	} else {
		audiobutton = document.getElementById(AUDIOid);
 		if (!audiobutton) {
			return;
		}
		if (audiobutton.className.match(/mp3/)) {
			audiobutton.className = 'mp3pause';
		} else {
			audiobutton.className = 'pause';
		}
		if (element.className.match(/mp3/)) {
			element.className = 'mp3play';
		} else {
			element.className = 'play';
		}
		AUDIO.pause();
		AUDIO.removeAttribute('controls');
	}
}



//////////////////////////////
//
// ClearWorklistCache --
//

function ClearWorklistCache() {
   localStorage.removeItem('WORKLIST');
   localStorage.removeItem('WORKLISTrefreshtime');
   localStorage.removeItem('WORKjrpid');
   sessionStorage.removeItem('RECENTLYADDEDHTML');
}



//////////////////////////////
//
// audioStoppedAction -- 
//

function audioStoppedAction(event) {



}



//////////////////////////////
//
// DisplayCriticalNotes --
//

function DisplayCriticalNotes(jrpid, target) {
   ReadFileAsync("/data?id=" + jrpid + "&a=critical", function(responseText) {
		if (responseText.match(/^\s*$/)) {
			return;
		}
	   var element = document.getElementById(target);
		if (!element) {
			return;
		}

		element.innerHTML = responseText;

		var i;
		var content;

		var h4s = element.querySelectorAll("h2");
		for (i=0; i<h4s.length; i++) {
			content = h4s[i].innerHTML;
		 	h4s[i].outerHTML = '<h4>' + content + '</h4>';
		}

		var h3s = element.querySelectorAll("h1");
		for (i=0; i<h3s.length; i++) {
			content = h3s[i].innerHTML;
		 	h3s[i].outerHTML = '<h3 class="brown-border">' + content + '</h3>';
		}

	});
}

</script> 

<script>

//////////////////////////////
//
// keypresses --
//

window.addEventListener('keydown', function(event) {

	var widthbox = document.querySelector("input#width");

	if (event.target.id === widthbox.id) {
			return;
	}
	if (event.metaKey) {
			return;
	}

	var voice1 = document.querySelector("#v1");
	var voice2 = document.querySelector("#v2");
	var voice3 = document.querySelector("#v3");
	var voice4 = document.querySelector("#v4");

	switch(event.keyCode) {

			case ZeroKey:
				var anyon = false;
				anyon |= voice1.checked;
				anyon |= voice2.checked;
				anyon |= voice3.checked;
				anyon |= voice4.checked;

				if (!anyon) {
				voice1.checked = true;
				voice2.checked = true;
				voice3.checked = true;
				voice4.checked = true;
				} else {
				voice1.checked = false;
				voice2.checked = false;
				voice3.checked = false;
				voice4.checked = false;
				}

				displayVoice(voice4.checked, 4);
				displayVoice(voice3.checked, 3);
				displayVoice(voice2.checked, 2);
				displayVoice(voice1.checked, 1);
				break;

			case OneKey:
				if (event.shiftKey) {
					if (voice1.checked && !(voice2.checked || 
							voice3.checked || voice4.checked)) {
						voice1.checked = false;
						voice2.checked = true;
						voice3.checked = true;
						voice4.checked = true;
					} else {
						voice1.checked = true;
						voice2.checked = false;
						voice3.checked = false;
						voice4.checked = false;
					}
				   displayVoice(voice1.checked, 4);
				   displayVoice(voice2.checked, 3);
				   displayVoice(voice3.checked, 2);
				   displayVoice(voice4.checked, 1);
				} else {
				   voice1.checked = !voice1.checked;
				   TRACK_STATES = voice1.checked ? 1 : 0;
				   displayVoice(voice1.checked, 4);
				}
				break;

			case TwoKey:
				if (event.shiftKey) {
					if (voice2.checked && !(voice1.checked || 
							voice3.checked || voice4.checked)) {
						voice1.checked = true;
						voice2.checked = false;
						voice3.checked = true;
						voice4.checked = true;
					} else {
						voice1.checked = false;
						voice2.checked = true;
						voice3.checked = false;
						voice4.checked = false;
					}
				   displayVoice(voice1.checked, 4);
				   displayVoice(voice2.checked, 3);
				   displayVoice(voice3.checked, 2);
				   displayVoice(voice4.checked, 1);
				} else {
				  	voice2.checked = !voice2.checked;
				   TRACK_STATES = voice2.checked ? 1 : 0;
				   displayVoice(voice2.checked, 3);
				}
				break;

			case ThreeKey:

				if (event.shiftKey) {
					if (voice3.checked && !(voice1.checked || 
							voice2.checked || voice4.checked)) {
						voice1.checked = true;
						voice2.checked = true;
						voice3.checked = false;
						voice4.checked = true;
					} else {
						voice1.checked = false;
						voice2.checked = false;
						voice3.checked = true;
						voice4.checked = false;
					}
				   displayVoice(voice1.checked, 4);
				   displayVoice(voice2.checked, 3);
				   displayVoice(voice3.checked, 2);
				   displayVoice(voice4.checked, 1);
				} else {
				   voice3.checked = !voice3.checked;
				   TRACK_STATES = voice3.checked ? 1 : 0;
				   displayVoice(voice3.checked, 2);
				}
				break;

			case FourKey:

				if (event.shiftKey) {
					if (voice4.checked && !(voice1.checked || 
							voice2.checked || voice3.checked)) {
						voice1.checked = true;
						voice2.checked = true;
						voice3.checked = true;
						voice4.checked = false;
					} else {
						voice1.checked = false;
						voice2.checked = false;
						voice3.checked = false;
						voice4.checked = true;
					}
				   displayVoice(voice1.checked, 4);
				   displayVoice(voice2.checked, 3);
				   displayVoice(voice3.checked, 2);
				   displayVoice(voice4.checked, 1);

				} else {
					voice4.checked = !voice4.checked;
					TRACK_STATES = voice4.checked ? 1 : 0;
					displayVoice(voice4.checked, 1);
				}
				break;

			case BKey:
            var svg = document.querySelector("svg");
            if (svg) {
               var background = svg.querySelector("rect.background");
               if (background) {
                  var opacity = background.getAttribute("opacity");
						if (!opacity) {
                     opacity = 1.0;
						}
                  opacity = 1.0 - opacity;
                  background.setAttribute("opacity", opacity);
               }
            }
            break;

			case CKey:
				var interface = document.querySelector("#interface");
				if (interface.style.visibility === 'hidden') {
				   interface.style.visibility = 'visible';
				   interface.style.display = 'inline';
				} else {
				   interface.style.visibility = 'hidden';
				   interface.style.display = 'none';
				}
				break;

			case HKey:
				displayFullHeight();
				break;

			case GKey:
				var gs = document.querySelector("#grand-staff");
				gs.checked = !gs.checked;
				displayStafflines(gs.checked);
				break;

			case NKey:
				var minima = document.querySelector("#minima");
				minima.checked = !minima.checked;
				displayMinima(minima.checked);
				break;

			case RKey:
				var round = document.querySelector("#round-notes");
				round.checked = !round.checked;
				displayRound(round.checked);
				break;

			case WKey:
				displayFullWidth();
				break;

			case XKey:
				var maxima = document.querySelector("#maxima");
				maxima.checked = !maxima.checked;
				displayMaxima(maxima.checked);
				break;

         case SpaceKey:
            var audio = document.querySelector("audio");
            if (!audio) {
               PlayAudioFile2('Jos2824');
               var audio = document.querySelector("audio");
               if (audio) {
                  audio.pause();
               }
            }
            if (audio) {
               if (audio.paused) {
                  audio.play();
               } else {
                  audio.pause();
               }
            }
            break;

			case SlashKey:
				var help = document.querySelector("#help");
				if (help.style.display === 'none') {
               help.style.display = 'block';
            } else {
               help.style.display = 'none';
            }
				break;

			case SquareLeftKey:
				var width = document.querySelector("#width");
				var value = width.value;
				value = parseInt(value) - 50;
				if (value < 100) {
				value = 100;
				}
				width.value = value;
				displayWidth(value);
				break;

			case SquareRightKey:
				var width = document.querySelector("#width");
				var value = width.value;
				value = parseInt(value) + 50;
				if (value > 800) {
				value = 800;
				}
				width.value = value;
				displayWidth(value);
				break;

	}
	 

});



//////////////////////////////
//
// displayVoice -- Show/hide voices.
//

function displayVoice(state, track) {
	var svg = document.querySelector("svg");
	var list = svg.querySelectorAll(".track-" + track);
	var list2 = svg.querySelectorAll(".note-background-" + track);
	for (var i=0; i<list.length; i++) {
			if (state) {
				list[i].style.visibility = 'visible';
			} else {
				list[i].style.visibility = 'hidden';
			}
	}
}



//////////////////////////////
//
// displayStafflines -- Show/hide grand staff.
//

function displayStafflines(state) {
	var svg = document.querySelector("svg");
	var list = svg.querySelectorAll(".staff-lines");
	for (var i=0; i<list.length; i++) {
			if (state) {
				list[i].style.visibility = 'visible';
			} else {
				list[i].style.visibility = 'hidden';
			}
	}
}



//////////////////////////////
//
// displayLines -- Show/hide melody connector lines.
//

function displayLines(state) {
	var svg = document.querySelector("svg");
	var list = svg.querySelectorAll(".note-lines");
	for (var i=0; i<list.length; i++) {
			if (state) {
				list[i].style.visibility = 'visible';
			} else {
				list[i].style.visibility = 'hidden';
			}
	}
}



//////////////////////////////
//
// displayMaxima -- Highlight minima/maxima of tessitura.
//

function displayMaxima(state) {
	var svg = document.querySelector("svg");
	var i;
	var list = svg.querySelectorAll(".maxima");
	for (i=0; i<list.length; i++) {
			if (state) {
				list[i].setAttribute("fill", "red");
			} else {
				list[i].setAttribute("fill", "");
			}
	}
}



//////////////////////////////
//
// displayMinima -- Highlight minima/maxima of tessitura.
//

function displayMinima(state) {
	var svg = document.querySelector("svg");
	var i;
	var list = svg.querySelectorAll(".minima");
	for (i=0; i<list.length; i++) {
			if (state) {
				list[i].setAttribute("fill", "red");
			} else {
				list[i].setAttribute("fill", "");
			}
	}
}



//////////////////////////////
//
// displayRound -- Switch between round and square notes.
//

function displayRound(state) {
	var svg = document.querySelector("svg");
	var list = svg.querySelectorAll("rect[rx]");
	for (var i=0; i<list.length; i++) {
			if (state) {
				list[i].setAttribute('rx', 1);
				list[i].setAttribute('ry', 1);
			} else {
				list[i].setAttribute('rx', 0);
				list[i].setAttribute('ry', 0);
			}
	}
}



//////////////////////////////
//
// displayWidth -- Adjust size of image
//

function displayWidth(width) {
	var fullwidth = window.innerWidth;
	var svg = document.querySelector("svg");
	var viewbox = svg.getAttribute("viewBox");
	var pieces = viewbox.split(" ");
	var ratio = pieces[3] / pieces[2];
	svg.setAttribute("width", fullwidth * width / 100);
	svg.setAttribute("height", fullwidth * width / 100 * ratio);
}



//////////////////////////////
//
// displayFullHeight -- Adjust size of image to full screen height.
//

function displayFullHeight() {
	// var fullheight = window.innerHeight;
	var tb = document.querySelector("#svg-table");
	var svg = document.querySelector("svg");

	var fullheight = window.innerHeight;
	var imagey = tb.offsetTop - tb.scrollTop + tb.clientTop;
   var imageheight = fullheight - imagey;
	var fullwidth = window.innerWidth;
	var viewbox = svg.getAttribute("viewBox");
	var pieces = viewbox.split(" ");
	var ratio = pieces[3] / pieces[2];
   var width = document.querySelector("#width");

   currentWidth  = svg.getAttribute("width");
   currentHeight = svg.getAttribute("height");
   if (Math.abs(imageheight - currentHeight) < 1) {
	   svg.setAttribute("width", LASTWIDTH);
      width.value = parseInt(LASTWIDTH/fullwidth*100+0.5);
	   svg.setAttribute("height", LASTHEIGHT);
   } else {
      LASTWIDTH  = currentWidth;
      LASTHEIGHT = currentHeight;
	   svg.setAttribute("width", imageheight / ratio);
      width.value = parseInt(imageheight/ratio/fullwidth*100+0.5);
	   svg.setAttribute("height", imageheight);
   }
}



//////////////////////////////
//
// displayFullWidth -- Adjust size of image to full screen height.
//

function displayFullWidth() {
	// var fullheight = window.innerHeight;
	var tb = document.querySelector("#svg-table");
	var svg = document.querySelector("svg");

	var fullwidth = window.innerWidth;
	var viewbox = svg.getAttribute("viewBox");
	var pieces = viewbox.split(" ");
	var ratio = pieces[3] / pieces[2];
   var width = document.querySelector("#width");

   currentWidth  = svg.getAttribute("width");
   currentHeight = svg.getAttribute("height");

   if (LASTWIDTH < 0) {
      LASTWIDTH  = currentWidth;
      LASTHEIGHT = currentHeight;
   } 

   if ((LASTWIDTH < 0) || (Math.abs(fullwidth - currentWidth) < 1)) {
	   svg.setAttribute("width", LASTWIDTH);
      width.value = parseInt(LASTWIDTH/fullwidth*100+0.5);
	   svg.setAttribute("height", LASTHEIGHT);
   } else if (LASTWIDTH > 0) {
      LASTWIDTH  = currentWidth;
      LASTHEIGHT = currentHeight;
	   svg.setAttribute("width", fullwidth);
	   svg.setAttribute("height", fullwidth * ratio);
      width.value = 100.0;
   }
}



</script>

	</body>
</html>
<!-- vim: set ts=2: -->

